<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calcul bague / fraise</title>
  <style>
    :root{
      --cell-font-size: clamp(14px, 4vw, 18px);
      --cell-padding-y: 12px;
      --cell-padding-x: 10px;
      --pill-padding-y: clamp(8px, 2.5vw, 12px);
      --pill-padding-x: clamp(10px, 3vw, 16px);
      --gap-between-cells: 4px;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    h1 {
      background-color: #1E90FF;
      color: white;
      padding: 10px;
      margin: 0;
      font-size: clamp(18px, 5vw, 26px);
    }

    .tabs {
      display: flex;
      justify-content: center;
      margin: 15px 8px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .tab-button {
      background-color: #e0e0e0;
      border: none;
      padding: 10px 18px;
      font-size: clamp(14px, 4vw, 18px);
      cursor: pointer;
      border-radius: 8px;
      font-weight: bold;
      min-width: 140px;
    }
    .tab-button.active { background-color: #1E90FF; color: white; }

    .tab-content { display: none; padding: 10px; }
    .tab-content.active { display: block; }

    .action-buttons { margin: 10px 0; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .action-buttons button {
      padding: 10px 16px;
      margin: 0;
      font-size: clamp(14px, 4vw, 18px);
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #1E90FF;
      color: white;
      font-weight: bold;
    }

    .table-container { width: 100%; overflow-x: auto; margin-top: 12px; padding: 0 8px; box-sizing: border-box; }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: var(--gap-between-cells);
      font-size: var(--cell-font-size);
      text-align: center;
      margin-bottom: 12px;
    }

    th, td {
      padding: var(--cell-padding-y) var(--cell-padding-x);
      border-radius: 10px;
      font-weight: 600;
      line-height: 1.25;
      vertical-align: middle;
      word-break: break-word;
      box-sizing: border-box;
    }

    th {
      background-color: #1E90FF;
      color: #fff;
      font-size: clamp(15px, 4vw, 22px);
    }

    tbody tr:nth-child(even) td { background-color: #f2f6fc; }
    tbody tr:nth-child(odd) td  { background-color: #e9eef8; }

    td[contenteditable] {
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 8px;
      padding: var(--cell-padding-y) var(--cell-padding-x);
      font-size: var(--cell-font-size);
      min-width: 44px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
    }

    .fraise-cell, .couple-cell, .decalage-cell {
      display:inline-block;
      padding: var(--pill-padding-y) var(--pill-padding-x);
      border-radius: 10px;
      font-weight:700;
      margin: 2px 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.12);
      font-size: var(--cell-font-size);
      min-width: 48px;
    }
    .fraise-cell { background:#cce0ff; color:#003366; }
    .couple-cell { background:#c8f7c5; color:#064d00; }
    .decalage-cell { background:#ffe9a7; color:#663c00; }

    .delete-btn {
      background:#ff4d4d;
      color:white;
      border:none;
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
    }

    @media (max-width:600px){
      th, td { padding: calc(var(--cell-padding-y) + 4px) calc(var(--cell-padding-x) - 2px); }
      .fraise-cell, .couple-cell, .decalage-cell {
        font-size: clamp(16px, 4.5vw, 22px);
        padding: calc(var(--pill-padding-y) + 2px) calc(var(--pill-padding-x) + 2px);
      }
      .tab-button { min-width: 110px; }
    }
  </style>
</head>
<body>

  <h1>‚öôÔ∏è Calcul des couples bague/fraise</h1>

  <!-- Onglets -->
  <div class="tabs">
    <button class="tab-button active" onclick="openTab(0)">2 Bagues 1 Fraise</button>
    <button class="tab-button" onclick="openTab(1)">2 Bagues 2 Fraises</button>
    <button class="tab-button" onclick="openTab(2)">Bagues & Fraises</button>
  </div>

  <!-- Onglet 1 -->
  <div class="tab-content active">
    <div class="action-buttons">
      <button onclick="calculer('principal')">Calculer</button>
    </div>
    <p style="font-weight:bold; color:#333; margin:8px 0;">
      üîµ Grosse bague = tenon<br>
      üü¢ Petite bague = mortaise
    </p>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>√ò Fraise</th><th>Couples (fraise / bague)</th><th>D√©calage</th></tr>
        </thead>
        <tbody id="resultatsPrincipal"></tbody>
      </table>
    </div>
  </div>

  <!-- Onglet 2 -->
  <div class="tab-content">
    <div class="action-buttons">
      <button onclick="calculer('inclusion')">Calculer</button>
    </div>
    <p style="font-weight:bold; color:#333; margin:8px 0;">
      üîµ Grosse bague = tenon<br>
      üü¢ Petite bague = mortaise
    </p>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Couples (fraise / bague)</th><th>D√©calage</th></tr>
        </thead>
        <tbody id="resultatsInclusion"></tbody>
      </table>
    </div>
  </div>

  <!-- Onglet 3 -->
  <div class="tab-content">
    <div class="action-buttons">
      <button onclick="calculer('all')">üìä Calculer tous</button>
      <button onclick="viderTables()">üóëÔ∏è Vider tout</button>
    </div>

    <div class="table-container">
      <table id="tableBagues">
        <thead>
          <tr><th>√ò Ext√©rieur</th><th>√ò Int√©rieur (limite fraise)</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="action-buttons">
        <button onclick="ajouterBagues()">‚ûï Ajouter bague</button>
      </div>
    </div>

    <div class="table-container">
      <table id="tableFraises">
        <thead>
          <tr><th>√ò Fraise</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="action-buttons">
        <button onclick="ajouterFraise()">‚ûï Ajouter fraise</button>
      </div>
    </div>
  </div>

<script>
const STORAGE_KEY = 'fraiseBagueData_v1';

const DEFAULT = {
  bagues: [
    { ext: '10', int: '8' },
    { ext: '12', int: '10' },
    { ext: '14', int: '12' },
    { ext: '16', int: '14' },
    { ext: '18', int: '16' },
    { ext: '20', int: '18' },
    { ext: '24', int: '22' },
    { ext: '30', int: '28' },
    { ext: '40', int: '28' },
    { ext: '50', int: '28' },
    { ext: '60', int: '28' }
  ],
  fraises: [
    { d: '8' }, { d: '10' }, { d: '12' }, { d: '14' }, { d: '16' }, { d: '19' }
  ]
};

function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT));
    return JSON.parse(JSON.stringify(DEFAULT));
  }
  try {
    return JSON.parse(raw);
  } catch(e){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT));
    return JSON.parse(JSON.stringify(DEFAULT));
  }
}
function saveData(data){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function renderTab3(){
  const data = loadData();
  const tbodyB = document.querySelector('#tableBagues tbody');
  tbodyB.innerHTML = '';
  data.bagues.forEach((b, idx) => {
    const tr = document.createElement('tr');

    const tdExt = document.createElement('td');
    tdExt.contentEditable = 'true';
    tdExt.innerText = b.ext;
    tdExt.addEventListener('input', onEditTable);
    tdExt.dataset.type = 'bague-ext';
    tdExt.dataset.index = idx;

    const tdInt = document.createElement('td');
    tdInt.contentEditable = 'true';
    tdInt.innerText = b.int;
    tdInt.addEventListener('input', onEditTable);
    tdInt.dataset.type = 'bague-int';
    tdInt.dataset.index = idx;

    const tdAction = document.createElement('td');
    const del = document.createElement('button');
    del.innerText = 'X';
    del.className = 'delete-btn';
    del.addEventListener('click', ()=>{ supprimerBague(idx); });
    tdAction.appendChild(del);

    tr.appendChild(tdExt);
    tr.appendChild(tdInt);
    tr.appendChild(tdAction);
    tbodyB.appendChild(tr);
  });

  const tbodyF = document.querySelector('#tableFraises tbody');
  tbodyF.innerHTML = '';
  data.fraises.forEach((f, idx) => {
    const tr = document.createElement('tr');

    const tdD = document.createElement('td');
    tdD.contentEditable = 'true';
    tdD.innerText = f.d;
    tdD.addEventListener('input', onEditTable);
    tdD.dataset.type = 'fraise-d';
    tdD.dataset.index = idx;

    const tdAction = document.createElement('td');
    const del = document.createElement('button');
    del.innerText = 'X';
    del.className = 'delete-btn';
    del.addEventListener('click', ()=>{ supprimerFraise(idx); });
    tdAction.appendChild(del);

    tr.appendChild(tdD);
    tr.appendChild(tdAction);
    tbodyF.appendChild(tr);
  });
}

function onEditTable(){
  const bagues = Array.from(document.querySelectorAll('#tableBagues tbody tr')).map(r => {
    const ext = r.cells[0].innerText.trim().replace(',', '.');
    const int = r.cells[1].innerText.trim().replace(',', '.');
    return { ext, int };
  });
  const fraises = Array.from(document.querySelectorAll('#tableFraises tbody tr')).map(r => {
    const d = r.cells[0].innerText.trim().replace(',', '.');
    return { d };
  });
  const data = { bagues, fraises };
  saveData(data);
}

function ajouterBagues(){
  const data = loadData();
  data.bagues.push({ ext: '', int: '' });
  saveData(data);
  renderTab3();
}
function ajouterFraise(){
  const data = loadData();
  data.fraises.push({ d: '' });
  saveData(data);
  renderTab3();
}
function supprimerBague(index){
  const data = loadData();
  data.bagues.splice(index,1);
  saveData(data);
  renderTab3();
}
function supprimerFraise(index){
  const data = loadData();
  data.fraises.splice(index,1);
  saveData(data);
  renderTab3();
}
function viderTables(){
  if(!confirm('Vider toutes les bagues et fraises et remettre les valeurs par d√©faut ?')) return;
  // Remettre les valeurs par d√©faut
  const data = JSON.parse(JSON.stringify(DEFAULT));
  saveData(data);
  renderTab3();
  renderResults();
}

function parseNum(str){
  if(str === undefined || str === null) return NaN;
  const s = String(str).trim().replace(',', '.');
  const v = parseFloat(s);
  return isFinite(v) ? v : NaN;
}

function lireBaguesPourCalc(){
  const data = loadData();
  return data.bagues.map(b => {
    return { ext: parseNum(b.ext), int: parseNum(b.int) };
  }).filter(b => !isNaN(b.ext) && !isNaN(b.int));
}
function lireFraisesPourCalc(){
  const data = loadData();
  return data.fraises.map(f => ({ d: parseNum(f.d) })).filter(f => !isNaN(f.d));
}

function renderResults(){
  const bagues = lireBaguesPourCalc();
  const fraises = lireFraisesPourCalc();
  const tol = 0.01;

  let html1 = '';
  fraises.forEach(f=>{
    for(let i=0;i<bagues.length;i++){
      for(let j=i+1;j<bagues.length;j++){
        let [bSmall,bLarge,intSmall,intLarge] = bagues[i].ext <= bagues[j].ext
          ? [bagues[i].ext, bagues[j].ext, bagues[i].int, bagues[j].int]
          : [bagues[j].ext, bagues[i].ext, bagues[j].int, bagues[i].int];
        if(f.d <= intSmall && f.d <= intLarge){
          const delta = (bSmall + f.d) / 2;
          if(Math.abs(delta - (bLarge - f.d) / 2) < tol){
            html1 += `<tr>
                       <td><span class="fraise-cell">F${f.d}</span></td>
                       <td><span class="couple-cell">B${bSmall} / B${bLarge}</span></td>
                       <td><span class="decalage-cell">${delta.toFixed(2)}</span></td>
                      </tr>`;
          }
        }
      }
    }
  });
  document.getElementById('resultatsPrincipal').innerHTML = html1 || `<tr><td colspan="3">Aucun r√©sultat</td></tr>`;

  let html2 = '';
  const seen = new Set();
  for(let i=0;i<bagues.length;i++){
    for(let j=i+1;j<bagues.length;j++){
      let [bSmall,bLarge,intSmall,intLarge] = bagues[i].ext <= bagues[j].ext
        ? [bagues[i].ext, bagues[j].ext, bagues[i].int, bagues[j].int]
        : [bagues[j].ext, bagues[i].ext, bagues[j].int, bagues[i].int];
      fraises.forEach(f1=>{
        fraises.forEach(f2=>{
          if(f1.d === f2.d) return;
          if(f1.d <= intSmall && f2.d <= intLarge){
            const delta = (bSmall + f1.d) / 2;
            if(Math.abs(delta - (bLarge - f2.d) / 2) < tol){
              const key = `${bSmall}_${bLarge}_${f1.d}_${f2.d}`;
              if(!seen.has(key)){
                seen.add(key);
                html2 += `<tr>
                           <td>
                             <span class="couple-cell">F${f1.d} / B${bSmall}</span>
                             <span class="couple-cell">F${f2.d} / B${bLarge}</span>
                           </td>
                           <td><span class="decalage-cell">${delta.toFixed(2)}</span></td>
                          </tr>`;
              }
            }
          }
        });
      });
    }
  }
  document.getElementById('resultatsInclusion').innerHTML = html2 || `<tr><td colspan="2">Aucun r√©sultat</td></tr>`;
}

function calculer(mode){
  renderResults();
}

function renderAll(){
  renderTab3();
  renderResults();
}

function openTab(index){
  const contents = document.querySelectorAll('.tab-content');
  const buttons  = document.querySelectorAll('.tab-button');
  contents.forEach((c,i)=>c.classList.toggle('active', i===index));
  buttons.forEach((b,i)=>b.classList.toggle('active', i===index));
}

window.addEventListener('load', ()=>{
  renderAll();
  window.addEventListener('beforeunload', ()=>{ onEditTable(); });
});
</script>

</body>
</html>